{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C&sla</title>
    <link rel="icon" type="image/x-icon" href="{% static 'Image/img/logo_c&sla.png' %}">
    <!-- Agregar Font Awesome para los íconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css">
    <link rel="stylesheet" href="{% static 'Css/HeaderFooter.css' %}">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>
<body>
    <header>
        <img src="{% static 'Image/img/logo_c&sla.png' %}" alt="Logo" class="logo">
        
        <!-- Botón Hamburguesa - Visible solo en móviles -->
        <button class="hamburger-btn" id="hamburgerBtn">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Menú de navegación principal -->
        <nav class="main-nav" id="mainNav">
            <a href="/#Menu">Home</a>
            {% if request.session.usuario_id %}
            
           <div class="dropdown">
    <button class="dropbtn" style="border:none;">Inventario</button>
    <div class="dropdown-content">
        
        <strong style="padding: 8px 16px; display: block; color: #666;">🌱 Cultivos</strong>
        <a href="#" id="btn-tipos-cultivo">Tipos de cultivos</a>
        <a href="{% url 'TablaCultivo' %}">Cultivos</a>
        <a onclick="showParcelsTable()">Parceras de la finca</a>
        <hr>
        <strong style="padding: 8px 16px; display: block; color: #666;">🐄 Ganadería</strong>
        <a href="{% url 'TablaGanado' %}">Ganado</a>
        <a onclick="ShowRazas()">Razas de ganado</a>
        
    </div>
</div>
            
            <div class="dropdown">
                <button class="dropbtn" style="border:none;">Usuarios </button>
                <div class="dropdown-content">
                    <a href="{% url 'TablaSolicitudesUsuarios' %}">Ver Solicitudes</a>
                    <a href="{% url 'TablaUsuarios' %}">Ver usuarios</a>
                </div>
            </div>
            {% endif %}
            
            <a href="/#sobre-nosotros">Sobre Nosotros</a>
            <a href="/#Gestiona">Gestiona</a>
            <a href="/#Contactanos">Contáctanos</a>
            
            <!-- Botón de inicio de sesión - visible en móviles -->
            <a href="{% url 'PlantillaLogueo' %}" class="mobile-login-btn">
                <button class="custom-button">Iniciar Sesión</button>
            </a>
        </nav>
        
        <!-- Botón de inicio de sesión - visible en desktop -->
         
        <div class="desktop-login">
    {% if request.session.usuario_id %}
        <form action="{% url 'LogoutUser' %}" method="post" style="display:inline;">
            {% csrf_token %}
            <button class="custom-button bg-red-600 hover:bg-red-700">Cerrar Sesión</button>
        </form>
    {% else %}
        <a href="{% url 'PlantillaLogueo' %}">
            <button class="custom-button">Iniciar Sesión</button>
        </a>
    {% endif %}
</div>
    </header>

    <div id="box_race"></div>
    <script src="{% static 'JavaScripts/Cultivo/Alerta.js' %}"></script>
    <script >
        function showParcelsTable() {
            fetch('{% url "listar_parcelas" %}')
                .then(response => response.json())
                .then(parcelas => {
                    let tableHtml = `
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

                            .swal2-title {
                            font-family: 'Poppins', sans-serif !important;
                            font-weight: 600;
                            font-size: 24px;
                            color: #2e2e2e;
                        }
                        
                        .swal2-table {
                            width: 100%;
                            text-align: center;
                        }
                        
                        .swal2-table th, .swal2-table td {
                            text-align: center !important;
                            vertical-align: middle !important;
                        }
                        
                        .btn-container {
                            display: flex;
                            justify-content: center;
                            gap: 8px;
                        }
                        
                        .btn {
                            margin: 0 auto;
                            display: block;
                        }    
                    </style>
                    <button onclick="showAddParcelAlert()"  style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;" class="btn">Agregar Parcela</button>
                    <br>
                        <table class="swal2-table" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    parcelas.forEach(parcela => {
                        tableHtml += `
            <tr>
                <td>${parcela.nombre}</td>
                <td>${parcela.estado}</td>
                <td>
                    <button onclick="Desactivar(${parcela.id})" 
                        id="btn-estado-${parcela.id}"
                        style="padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; background-color:#f69c9c"
                        class="btn-estado"
                        data-estado-actual="${parcela.estado}">
                        ${parcela.estado === 2 ? 'Desabiliar' : 'Desabiliar'}
                    </button>
                    <button onclick="Activar(${parcela.id})" 
                        id="btn-estado-${parcela.id}"
                        style="padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; background-color: ${parcela.estado === 1 ? '#d33' : '#4CAF50'}; color: white;"
                        class="btn-estado"
                        data-estado-actual="${parcela.estado}">
                        ${parcela.estado === 2 ? 'Activar' : 'Activar'}
                    </button>
                </td>
            </tr>`;
                    });

                    Swal.fire({
                        title: 'Parcelas Registradas',
                        html: tableHtml,
                        width: '70%',
                        showConfirmButton: false,
                        showCloseButton: true
                    });
                })
                .catch(error => {
                    Swal.fire('Error', 'No se pudieron cargar las parcelas', 'error');
                    console.error(error);
                });
        }
        function showAddParcelAlert() {
            Swal.fire({
                title: 'Agregar Parcela',
                html: `
                <style>
                        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

                    .swal2-title {
                    font-family: 'Poppins', sans-serif !important;
                    font-weight: 600;
                    font-size: 24px;
                    color: #2e2e2e;
                }    
                    </style>
                    <input id="nombre" class="swal2-input" placeholder="Nombre" required>
                    <input id="estado" class="swal2-input" placeholder="Estado" required>
                `,
                confirmButtonText: 'Guardar',
                focusConfirm: false,
                preConfirm: () => {
                    return {
                        nombre: document.getElementById('nombre').value,
                        estado: document.getElementById('estado').value
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('{% url "agregar_parcela" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}',
                        },
                        body: JSON.stringify(result.value)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('¡Éxito!', 'Parcela guardada correctamente.', 'success');
                            showParcelsTable();  // Actualizar la tabla
                        } else {
                            Swal.fire('Error', data.error || 'Error desconocido', 'error');
                        }
                    })
                    .catch(error => {
                        Swal.fire('Error', 'Error en la conexión', 'error');
                        console.error(error);
                    });
                }
            });
        }
        function Activar(parcelaId) {
            // Guardar referencia al botón original antes de abrir el SweetAlert
            const botonOriginal = document.querySelector(`#btn-estado-${parcelaId}`);
            
            Swal.fire({
                title: '¿Cambiar estado de la parcela?',
                text: "Estás a punto de cambiar el estado de esta parcela",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, cambiar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/parcelas/${parcelaId}/cambiar-estado/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la respuesta del servidor');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Actualizar el botón ORIGINAL (no el del SweetAlert)
                            if (botonOriginal) {
                                if (data.nuevo_estado === 1) {
                                    botonOriginal.textContent = 'Hola';
                                    botonOriginal.style.backgroundColor = '#d33';
                                } else{
                                    botonOriginal.textContent = 'Hola';
                                    botonOriginal.style.backgroundColor = '#4CAF50';
                                }
                                
                                // Actualizar también el atributo data-estado-actual
                                botonOriginal.setAttribute('data-estado-actual', data.nuevo_estado);
                            }
                            
                            Swal.fire(
                                '¡Estado cambiado!',
                                data.message,
                                'success'
                            ).then(() => {
                                // Opcional: Recargar la tabla completa para asegurar consistencia
                                showParcelsTable();
                            });
                        } else {
                            Swal.fire(
                                'Error',
                                data.message || 'Ocurrió un error al cambiar el estado',
                                'error'
                            );
                        }
                    })
                    .catch(error => {
                        Swal.fire(
                            'Error',
                            'Error en la conexión: ' + error.message,
                            'error'
                        );
                        console.error('Error:', error);
                    });
                }
            });
        }
        function Desactivar(parcelaId) {
            // Guardar referencia al botón original antes de abrir el SweetAlert
            const botonOriginal = document.querySelector(`#btn-estado-${parcelaId}`);
            
            Swal.fire({
                title: '¿Cambiar estado de la parcela?',
                text: "Estás a punto de cambiar el estado de esta parcela",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, cambiar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/parcelas/${parcelaId}/cambiar/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la respuesta del servidor');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Actualizar el botón ORIGINAL (no el del SweetAlert)
                            if (botonOriginal) {
                                if (data.nuevo_estado === 1) {
                                    botonOriginal.textContent = 'Hola';
                                    botonOriginal.style.backgroundColor = '#d33';
                                } else{
                                    botonOriginal.textContent = 'Hola';
                                    botonOriginal.style.backgroundColor = '#4CAF50';
                                }
                                
                                // Actualizar también el atributo data-estado-actual
                                botonOriginal.setAttribute('data-estado-actual', data.nuevo_estado);
                            }
                            
                            Swal.fire(
                                '¡Estado cambiado!',
                                data.message,
                                'success'
                            ).then(() => {
                                // Opcional: Recargar la tabla completa para asegurar consistencia
                                showParcelsTable();
                            });
                        } else {
                            Swal.fire(
                                'Error',
                                data.message || 'Ocurrió un error al cambiar el estado',
                                'error'
                            );
                        }
                    })
                    .catch(error => {
                        Swal.fire(
                            'Error',
                            'Error en la conexión: ' + error.message,
                            'error'
                        );
                        console.error('Error:', error);
                    });
                }
            });
        }

        //Razas

        function ShowRazas() {
            fetch('{% url "ListaRazas" %}')
                .then(response => response.json())
                .then(razas => {
                    let tableHtml = `
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

                    .swal2-title {
                        font-family: 'Poppins', sans-serif !important;
                        font-weight: 600;
                        font-size: 24px;
                        color: #2e2e2e;
                    }   
                    
                    .swal2-table {
                        width: 100%;
                        text-align: center;
                    }
                        
                    .swal2-table th, .swal2-table td {
                        text-align: center !important;
                        vertical-align: middle !important;
                    }
                        
                    .btn-container {
                        display: flex;
                        justify-content: center;
                        gap: 8px;
                    }
                        
                    .btn {
                        margin: 0 auto;
                        display: block;
                    }    


                    </style>
                        <button onclick="AgregarRaza()" 
                            style="background: #3d9140; color: white; display: flex; justify-content: center; align-items: center; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; " 
                            class="btn">Agregar Razas</button>
                        <br><br>
                        <table class="swal2-table" style="width:100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #d2f4d2;">
                                    <th style="padding: 10px; border: 1px solid #ccc;">Nombre</th>
                                    <th style="padding: 10px; border: 1px solid #ccc;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>`;

                    razas.forEach((raza, index) => {
                        const bgColor = index % 2 === 0 ? '#ffffff' : '#ffffff';
                        tableHtml += `
                            <tr style="background-color: ${bgColor};">
                                <td style="padding: 10px; border: 1px solid #ccc;">${raza.nombre}</td>
                                <td style="padding: 10px; border: 1px solid #ccc;">
                                    <button onclick="Desactivar(${raza.id})" 
                                        id="btn-estado-${raza.id}"
                                        style="padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; background-color:#f69c9c">
                                        Eliminar
                                    </button>
                                </td>
                            </tr>`;
                    });

                    tableHtml += `</tbody></table>`;

                    Swal.fire({
                        title: 'Razas Registradas',
                        html: tableHtml,
                        width: '70%',
                        showConfirmButton: false,
                        showCloseButton: true
                    });
                })
                .catch(error => {
                    Swal.fire('Error', 'No se pudieron cargar las razas', 'error');
                    console.error(error);
                });
        }
        function AgregarRaza() {
            Swal.fire({
                title: 'Agregar Raza',
                html: `
                <style>
                        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

                    .swal2-title {
                    font-family: 'Poppins', sans-serif !important;
                    font-weight: 600;
                    font-size: 24px;
                    color: #2e2e2e;
                }    
                    </style>
                    <input id="nombre" class="swal2-input" placeholder="Nombre de la raza" required>
                `,
                confirmButtonText: 'Guardar',
                focusConfirm: false,
                preConfirm: () => {
                    return {
                        nombre: document.getElementById('nombre').value
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('{% url "AgregarRaza" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}',
                        },
                        body: JSON.stringify(result.value)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('¡Éxito!', 'Raza guardada correctamente.', 'success');
                            ShowRazas();  // Actualizar la tabla
                        } else {
                            Swal.fire('Error', data.error || 'Error desconocido', 'error');
                        }
                    })
                    .catch(error => {
                        Swal.fire('Error', 'Error en la conexión', 'error');
                        console.error(error);
                    });
                }
            });
        }

        //Tipo Cultivo

   document.getElementById("btn-tipos-cultivo").addEventListener("click", async function () {
    const response = await fetch("/Cultivo/api/tipos/"); // Cambia la URL según tu ruta
    const tipos = await response.json();

    let tableHTML = `
        <style>
            .swal2-popup {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }
            .tabla-categorias {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 10px;
                
            }
            .tabla-categorias th, .tabla-categorias td {
                border-bottom: 1px solid #ddd;
                padding: 8px;
                text-align: center;
            }
            .tabla-categorias th {
                background-color: #f2f2f2;
                font-weight: bold;
            }
            .tabla-categorias tr:hover {
                background-color: #f9f9f9;
            }
            .btn-eliminar {
                background-color: #e74c3c;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 4px;
                cursor: pointer;
            }
            .btn-eliminar:hover {
                background-color: #c0392b;
            }
            #nueva-categoria {
                width: 100%;
                padding: 8px;
                margin-top: 10px;
                border: 1px solid #ccc;
                border-radius: 4px;
            }
        </style>
        <table class="tabla-categorias">
            <thead>
                <tr>
                    <th>Categoría</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody>
                ${tipos.map(tipo => `
                    <tr>
                        <td>${tipo.nombre_tipo}</td>
                        <td><button class="btn-eliminar" onclick="eliminarTipo(${tipo.id})">Eliminar</button></td>
                    </tr>
                `).join("")}
            </tbody>
        </table>
        <input id="nueva-categoria" placeholder="Nueva categoría">
    `;

    Swal.fire({
        title: "Categorías de cultivos",
        html: tableHTML,
        showCancelButton: true,
        confirmButtonText: "Agregar",
        focusConfirm: false,
        preConfirm: () => {
            const nueva = document.getElementById("nueva-categoria").value;
            if (!nueva.trim()) {
                Swal.showValidationMessage("Debes ingresar una categoría");
                return false;
            }
            return fetch("/Cultivo/api/tipos/agregar/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: JSON.stringify({ nombre_tipo: nueva.trim() })
            });
        }
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire("Agregado", "La categoría fue agregada.", "success").then(() => {
                window.location.href = '?page=' + getCurrentPage();
            });
        }
    });
});

function eliminarTipo(id) {
    Swal.fire({
        title: "¿Eliminar categoría?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Sí, eliminar",
    }).then(result => {
        if (result.isConfirmed) {
            fetch(`/Cultivo/api/tipos/eliminar/${id}/`, {
                method: "DELETE",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken")
                }
            }).then(() => {
                Swal.fire("Eliminado", "Categoría eliminada", "success").then(() => {
                    window.location.href = '?page=' + getCurrentPage();
                });
            });
        }
    });
}

// Obtener CSRF Token de la cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


    </script>
</body>
</html>